name: release
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: '手动发布版本号（例如 1.2.3）'
        required: false
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore
        run: .\nuget.exe restore .\dual-sens-manager\dual-sens-manager.csproj

      - name: Build (x64 Release)
        run: msbuild .\dual-sens-manager\dual-sens-manager.csproj /m /p:Configuration=Release /p:Platform=x64

      - name: Package outputs
        shell: pwsh
        run: |
          $configuration = 'Release'
          & .\scripts\pack-release.ps1 -Configuration $configuration

          $ver = '${{ github.event.inputs.version }}'
          if ([string]::IsNullOrWhiteSpace($ver)) { $ver = '${{ github.ref_name }}' }

          $zipSource = "DualSensManager-$configuration.zip"
          if (-not (Test-Path $zipSource)) { throw "未生成 $zipSource" }

          $zipTarget = "DualSensManager-$ver.zip"
          Move-Item -Path $zipSource -Destination $zipTarget -Force

          $releaseDir = Join-Path (Get-Location) 'x64\Release'
          $stageRoot = Join-Path (Get-Location) 'portable-stage'
          $bundleDir = Join-Path $stageRoot 'DualSensManagerPortable'
          if (Test-Path $stageRoot) { Remove-Item $stageRoot -Recurse -Force }
          New-Item -ItemType Directory -Path $bundleDir | Out-Null

          $stageFiles = @(
            'DualSensManager.exe',
            'DualSensManager.exe.config',
            'wrapper.dll',
            'wrapper.pdb',
            'Newtonsoft.Json.dll',
            'Newtonsoft.Json.xml'
          )
          foreach ($file in $stageFiles) {
            $sourcePath = Join-Path $releaseDir $file
            if (Test-Path $sourcePath) {
              Copy-Item -Path $sourcePath -Destination (Join-Path $bundleDir $file) -Force
            }
          }

          $sevenZipDir = Join-Path $env:RUNNER_TEMP 'sevenzip'
          if (Test-Path $sevenZipDir) { Remove-Item $sevenZipDir -Recurse -Force }
          New-Item -ItemType Directory -Path $sevenZipDir | Out-Null

          $sevenZipDownloader = Join-Path $sevenZipDir '7zr.exe'
          Invoke-WebRequest -Uri 'https://www.7-zip.org/a/7zr.exe' -OutFile $sevenZipDownloader

          $extraArchive = Join-Path $sevenZipDir '7z2407-extra.7z'
          Invoke-WebRequest -Uri 'https://www.7-zip.org/a/7z2407-extra.7z' -OutFile $extraArchive
          & $sevenZipDownloader x $extraArchive ("-o$sevenZipDir") -y | Out-Null

          $installerArchive = Join-Path $sevenZipDir '7z2407-x64.exe'
          Invoke-WebRequest -Uri 'https://www.7-zip.org/a/7z2407-x64.exe' -OutFile $installerArchive
          & $sevenZipDownloader x $installerArchive ("-o$sevenZipDir") -y | Out-Null

          $sevenZip = Join-Path $sevenZipDir '7za.exe'
          if (-not (Test-Path $sevenZip)) { throw "未找到 7za.exe" }

          $sfxModule = Join-Path $sevenZipDir '7z.sfx'
          if (-not (Test-Path $sfxModule)) { throw "未找到 7z.sfx" }

          $portableArchive = "DualSensManager-$ver-portable.7z"
          $stageWildcard = Join-Path $stageRoot '*'
          & $sevenZip a -t7z $portableArchive $stageWildcard -mx=9 | Out-Null

          $configPath = 'sfx-config.txt'
          $configLines = @(
            ';!@Install@!UTF-8!',
            'Title="DualSensManager Portable"',
                        'RunProgram="DualSensManagerPortable\\DualSensManager.exe"',
            'GUIMode="2"',
            'OverwriteMode="2"',
            ';!@InstallEnd@!'
          )
          $configLines | Set-Content -Path $configPath -Encoding UTF8

          $portableExe = "DualSensManager-" + $ver + "-portable.exe"
          $copyCommand = "copy /b `"$sfxModule`" + `"$configPath`" + `"$portableArchive`" `"$portableExe`""
          cmd /c $copyCommand | Out-Null

          Remove-Item $configPath, $portableArchive -Force
          Remove-Item $stageRoot -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item $sevenZipDir -Recurse -Force -ErrorAction SilentlyContinue

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            DualSensManager-${{ github.event.inputs.version || github.ref_name }}.zip
            DualSensManager-${{ github.event.inputs.version || github.ref_name }}-portable.exe
          generate_release_notes: true
          tag_name: ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref_name }}
          target_commitish: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

